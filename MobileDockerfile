# syntax=docker/dockerfile:1
FROM ubuntu:20.04

ENV TZ=America/New_York
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

RUN dpkg --add-architecture i386
RUN apt update
RUN apt-get install -y wget build-essential ccache git zlib1g-dev python3 python3-dev python3-pip libncurses5:i386 libstdc++6:i386 zlib1g:i386 unzip ant ccache autoconf libtool libssl-dev libffi-dev zip

# Download Android SDK
RUN wget https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip
RUN unzip commandlinetools-linux-7583922_latest.zip
RUN mkdir /android-sdk
RUN yes | /cmdline-tools/bin/sdkmanager --sdk_root=/android-sdk --licenses
RUN /cmdline-tools/bin/sdkmanager --sdk_root=/android-sdk "platforms;android-27"
ENV ANDROIDSDK=/android-sdk

RUN /cmdline-tools/bin/sdkmanager --sdk_root=/android-sdk  "build-tools;28.0.2"

# Download Android NDK
RUN wget https://dl.google.com/android/repository/android-ndk-r19c-linux-x86_64.zip
RUN unzip android-ndk-r19c-linux-x86_64.zip
ENV ANDROIDNDK=/android-ndk-r19c
ENV ANDROIDAPI="27"
ENV NDKAPI="21"

RUN mkdir /app
COPY main.py /app
COPY /app /app/app

RUN pip install python-for-android cython virtualenv

# Purge open jdk and reinstall becuase one of the deps above pulls stuff it should not
RUN apt-get remove -y openjdk*
RUN apt-get install -y openjdk-8-jdk-headless

COPY build-mobile.sh /build-mobile.sh
RUN chmod +x build-mobile.sh

RUN mkdir /build

CMD sh /build-mobile.sh
